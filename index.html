<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Care AI Trainer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            position: relative;
        }
        .header {
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        .chat-container {
            height: 500px;
            overflow-y: auto;
            padding: 25px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            animation: fadeIn 0.3s ease;
        }
        .user-message { justify-content: flex-end; }
        .bot-message { justify-content: flex-start; }
        .message-bubble {
            max-width: 75%;
            padding: 15px 20px;
            border-radius: 18px;
            font-size: 16px;
            line-height: 1.5;
        }
        .user-bubble {
            background: #4f46e5;
            color: white;
            border-bottom-right-radius: 5px;
        }
        .bot-bubble {
            background: white;
            color: #333;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .input-area {
            padding: 25px;
            background: white;
            display: flex;
            gap: 12px;
        }
        textarea {
            flex: 1;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            resize: none;
            font-family: inherit;
            transition: border 0.3s;
        }
        textarea:focus {
            outline: none;
            border-color: #4f46e5;
        }
        button {
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        button:hover { background: #4338ca; }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .loading { display: none; }
        .loading.active {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        .rules {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            font-size: 14px;
        }
        /* KEY POPUP STYLES */
        #keyPopup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .popup-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .popup-box h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 24px;
        }
        .key-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #4f46e5;
            border-radius: 10px;
            font-size: 16px;
            margin: 15px 0;
            font-family: monospace;
        }
        .save-btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        .save-btn:hover { background: #4338ca; }
        .save-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .key-note {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }
        .key-note a {
            color: #4f46e5;
            text-decoration: none;
        }
        .key-note a:hover {
            text-decoration: underline;
        }
        .quick-buttons {
            display: flex;
            gap: 10px;
            padding: 0 25px 15px 25px;
            flex-wrap: wrap;
        }
        .quick-btn {
            background: #f3f4f6;
            color: #333;
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-btn:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
        }
        .clear-btn {
            background: #fee2e2;
            color: #dc2626;
            border-color: #fecaca;
        }
        .clear-btn:hover {
            background: #fecaca;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 640px) {
            .container { border-radius: 0; }
            .message-bubble { max-width: 85%; }
            body { padding: 0; }
            .popup-box { padding: 25px; }
            .quick-buttons { padding: 0 15px 15px 15px; }
        }
    </style>
</head>
<body>
    <!-- KEY POPUP -->
    <div id="keyPopup">
        <div class="popup-box">
            <h3>üîë Enter DeepSeek API Key</h3>
            <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                This trainer uses <strong>DeepSeek API</strong> (100% free, no credit card needed)
            </p>
            <input type="password" id="keyInput" class="key-input" 
                   placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                   autocomplete="off">
            <button onclick="saveKey()" class="save-btn" id="saveKeyBtn">Save & Start Training</button>
            
            <div style="margin-top: 25px; text-align: left; background: #f8fafc; padding: 15px; border-radius: 8px;">
                <strong style="display: block; margin-bottom: 8px; color: #4f46e5;">üìù How to get FREE key:</strong>
                <ol style="margin-left: 20px; font-size: 13px; color: #4b5563;">
                    <li>Go to <a href="https://platform.deepseek.com/api_keys" target="_blank" style="color: #4f46e5; font-weight: 500;">platform.deepseek.com/api_keys</a></li>
                    <li>Login or create free account</li>
                    <li>Click "Create API Key" button</li>
                    <li>Copy the key (starts with <code>sk-</code>)</li>
                    <li>Paste it above</li>
                </ol>
            </div>
            
            <p class="key-note" style="margin-top: 20px;">
                ‚úÖ <strong>Your key stays safe:</strong> Stored only in your browser ‚Ä¢ Never sent to any server
            </p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>ü§ñ Customer Care AI Trainer</h1>
            <p>Practice professional customer support responses with AI</p>
        </div>
        
        <div class="rules">
            <strong>ü§µ AI Training Rules:</strong> Always polite ‚Ä¢ Never blame client ‚Ä¢ Explain clearly ‚Ä¢ Show empathy ‚Ä¢ End professionally
        </div>
        
        <div class="quick-buttons">
            <button class="quick-btn" onclick="quickMessage('I want free plays now!')">üéÅ Free Plays Request</button>
            <button class="quick-btn" onclick="quickMessage('Your app crashed and I lost my data!')">üí• App Crash Complaint</button>
            <button class="quick-btn" onclick="quickMessage('Cancel my subscription immediately!')">‚ùå Cancel Subscription</button>
            <button class="quick-btn clear-btn" onclick="clearChat()">üóëÔ∏è Clear Chat</button>
        </div>
        
        <div class="chat-container" id="chatContainer">
            <div class="message bot-message">
                <div class="message-bubble bot-bubble">
                    üëã <strong>Welcome to Customer Care Trainer!</strong><br><br>
                    I'll help you practice professional responses to difficult client messages.<br><br>
                    <em>Click a scenario button above or type your own message.</em>
                </div>
            </div>
        </div>
        
        <div class="input-area">
            <textarea 
                id="messageInput" 
                placeholder="Type or paste client message here... (Press Shift+Enter for new line, Enter to send)" 
                rows="3"
            ></textarea>
            <button id="sendButton" onclick="sendMessage()">
                <span>Send</span>
                <span class="loading" id="loading">‚ü≥</span>
            </button>
        </div>
    </div>

    <script>
        // ‚úÖ CONFIGURATION
        let API_KEY = localStorage.getItem('customerCareKey') || '';
        const API_ENDPOINT = 'https://api.deepseek.com/v1/chat/completions';
        const MODEL_NAME = 'deepseek-chat';
        
        // Customer Care System Prompt (STRICT RULES)
        const SYSTEM_PROMPT = `You are a senior customer care agent. Follow these rules STRICTLY:
1. ALWAYS start with polite greeting (Hello, Hi, Good day)
2. NEVER blame or argue with client, even if they're rude
3. Explain policies clearly and patiently
4. If client asks for free plays, explain politely why not possible
5. Show empathy - acknowledge their frustration
6. End conversation professionally (Thank you, Best regards)
7. Keep responses concise (3-4 lines max)

Example good reply: "Hello, thank you for contacting us. I understand your concern about free plays. Let me explain how our bonus system works so we can help you better."

Now respond to the client's message as a professional customer care agent:`;

        // DOM Elements
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const loading = document.getElementById('loading');
        const keyPopup = document.getElementById('keyPopup');
        const saveKeyBtn = document.getElementById('saveKeyBtn');

        // Initialize
        loadChatHistory();
        checkAPIKey();

        // ==================== FUNCTIONS ====================

        function showKeyPopup() {
            keyPopup.style.display = 'flex';
            document.getElementById('keyInput').focus();
        }

        function checkAPIKey() {
            if (!API_KEY) {
                setTimeout(() => showKeyPopup(), 500);
            }
        }

        async function testAPIKey(key) {
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        messages: [{ role: 'user', content: 'Test' }],
                        max_tokens: 1
                    })
                });
                return response.ok;
            } catch (error) {
                console.log('Key test failed:', error.message);
                return false;
            }
        }

        async function saveKey() {
            const keyInput = document.getElementById('keyInput');
            const key = keyInput.value.trim();
            
            if (!key) {
                alert('Please enter your DeepSeek API key');
                return;
            }
            
            if (!key.startsWith('sk-')) {
                alert('Invalid key format. DeepSeek keys start with "sk-"');
                keyInput.focus();
                return;
            }
            
            // Test the key
            saveKeyBtn.textContent = 'Testing key...';
            saveKeyBtn.disabled = true;
            
            const isValid = await testAPIKey(key);
            
            if (!isValid) {
                saveKeyBtn.textContent = 'Save & Start Training';
                saveKeyBtn.disabled = false;
                alert('‚ùå Key validation failed. Please check:\n\n1. Key is correct and active\n2. You have API credits available\n3. Your network connection');
                return;
            }
            
            // Save key
            API_KEY = key;
            localStorage.setItem('customerCareKey', key);
            
            // Hide popup
            keyPopup.style.display = 'none';
            
            // Show success message
            chatContainer.innerHTML = '';
            addMessage('‚úÖ <strong>API Key verified successfully!</strong><br><br>I\'m ready to help you practice customer care responses. Try clicking a scenario button or type your own message.', 'bot');
            
            // Clear chat history
            localStorage.removeItem('customerCareChat');
            loadChatHistory();
            
            alert('‚úÖ Perfect! Your DeepSeek API key is working. You can now practice customer care responses.');
        }

        function loadChatHistory() {
            const savedChat = localStorage.getItem('customerCareChat');
            if (savedChat) {
                try {
                    const messages = JSON.parse(savedChat);
                    messages.forEach(msg => addMessage(msg.text, msg.role, false));
                } catch (e) {
                    console.error('Error loading chat history:', e);
                }
            }
        }

        function addMessage(text, role, saveToHistory = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = role === 'user' ? 'message user-message' : 'message bot-message';
            
            const bubble = document.createElement('div');
            bubble.className = role === 'user' ? 'message-bubble user-bubble' : 'message-bubble bot-bubble';
            bubble.innerHTML = text;
            
            messageDiv.appendChild(bubble);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Save to history
            if (saveToHistory && (role === 'user' || role === 'assistant')) {
                let chatHistory = JSON.parse(localStorage.getItem('customerCareChat')) || [];
                chatHistory.push({ text, role });
                if (chatHistory.length > 50) chatHistory = chatHistory.slice(-50);
                localStorage.setItem('customerCareChat', JSON.stringify(chatHistory));
            }
        }

        async function sendMessage() {
            // Check API key
            if (!API_KEY) {
                showKeyPopup();
                alert('Please enter your DeepSeek API key first');
                return;
            }
            
            const userMessage = messageInput.value.trim();
            if (!userMessage) {
                messageInput.focus();
                return;
            }
            
            // Add user message
            addMessage(userMessage, 'user');
            messageInput.value = '';
            sendButton.disabled = true;
            loading.classList.add('active');
            
            try {
                console.log('Sending to DeepSeek API...');
                
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        messages: [
                            { role: 'system', content: SYSTEM_PROMPT },
                            { role: 'user', content: userMessage }
                        ],
                        temperature: 0.7,
                        max_tokens: 300
                    })
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`API Error ${response.status}: ${errorData.error?.message || response.statusText}`);
                }
                
                const data = await response.json();
                console.log('API Response:', data);
                
                const aiReply = data.choices[0]?.message?.content || 
                               'Thank you for your message. How can I assist you today?';
                
                addMessage(aiReply, 'assistant');
                
            } catch (error) {
                console.error('Full error:', error);
                
                let errorMsg = '';
                let needNewKey = false;
                
                if (error.message.includes('401') || error.message.includes('403')) {
                    errorMsg = '‚ùå <strong>Invalid or expired API key</strong><br><br>';
                    errorMsg += 'Your DeepSeek API key is not working. Please ';
                    errorMsg += '<a href="javascript:showKeyPopup()" style="color: #4f46e5; text-decoration: underline;">click here to enter a valid key</a>.';
                    needNewKey = true;
                } else if (error.message.includes('429')) {
                    errorMsg = '‚ö†Ô∏è <strong>Rate limit exceeded</strong><br><br>';
                    errorMsg += 'DeepSeek has a limit of 50 requests per hour. Please wait 60 seconds and try again.';
                } else if (error.message.includes('network') || error.message.includes('Failed to fetch')) {
                    errorMsg = 'üåê <strong>Network error</strong><br><br>';
                    errorMsg += 'Please check your internet connection and try again.';
                } else {
                    errorMsg = `‚ö†Ô∏è <strong>Error</strong><br><br>${error.message.substring(0, 150)}`;
                }
                
                addMessage(errorMsg, 'assistant');
                
                if (needNewKey) {
                    localStorage.removeItem('customerCareKey');
                    API_KEY = '';
                    setTimeout(() => showKeyPopup(), 1000);
                }
                
            } finally {
                sendButton.disabled = false;
                loading.classList.remove('active');
                messageInput.focus();
            }
        }

        function quickMessage(text) {
            if (!API_KEY) {
                showKeyPopup();
                alert('Please enter your DeepSeek API key first');
                return;
            }
            messageInput.value = text;
            sendMessage();
        }

        function clearChat() {
            if (confirm('Clear all chat history? This cannot be undone.')) {
                localStorage.removeItem('customerCareChat');
                chatContainer.innerHTML = '';
                addMessage('Chat cleared. Ready for new practice session! Try a scenario button or type your own message.', 'bot');
            }
        }

        // ==================== EVENT LISTENERS ====================

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Focus input when popup closes
        keyPopup.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                keyPopup.style.display = 'none';
            }
        });

        // Allow Enter key in popup input
        document.getElementById('keyInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                saveKey();
            }
        });

        // Show key popup if needed
        setTimeout(() => {
            if (!API_KEY) {
                showKeyPopup();
            }
        }, 1000);

        // Auto-check key on page load
        window.addEventListener('load', () => {
            if (API_KEY && !localStorage.getItem('keyChecked')) {
                testAPIKey(API_KEY).then(isValid => {
                    if (!isValid) {
                        localStorage.removeItem('customerCareKey');
                        API_KEY = '';
                        setTimeout(() => showKeyPopup(), 1000);
                    } else {
                        localStorage.setItem('keyChecked', 'true');
                    }
                });
            }
        });
    </script>
</body>
</html>
